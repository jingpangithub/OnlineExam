<div class="row wrapper wrapper-content">
    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <h5>考试清除</h5>
            <div class="ibox-tools">
                <a class="btn btn-xs btn-primary" onclick="table.ajax.reload()">刷新</a>
            </div>
        </div>
        <div class="ibox-content">
            <div class="ibox-content">
                <p id="ptest"></p>
                <table id="exam_table" class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="width:14%">所属教师</th>
                            <th style="width:14%">所属专业</th>
                            <th style="width:20%">开始时间</th>
                            <th style="width:14%">持续时间</th>
                            <th style="width:18%">考试文档</th>
                            <th style="width:20%">操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section script {
    <script>       
        var filter = " ";
        var table = null;

        $.extend($.validator.messages, { required: '该项不能为空' });

        $(document).ready(function () {
            table = $("#exam_table").DataTable({
                "pageLength": 10,
                "lengthChange": false,
                "processing": true,
                "serverSide": true,
                "ordering": false,
                "dom": '< l < t > ip >',
                "ajax": function (tdata, callback, settings) {
                    $.ajax({
                        type: "POST",
                        url: "/ExamEnd/AjaxList/" + filter,
                        cache: false,
                        data: tdata,
                        dataType: "json",
                        success: function (res) {
                            if (res.result == 0) {
                                toastr.warning(res.msg);
                            } else if (res.result == 100) {
                                location.href = "/Login/Index";
                            } else {
                                callback(res.data);
                            }
                        },
                        error: function (XMLHttpRequest, txtStatus, errorThrown) {
                            toastr.warning('查询失败，请重试');
                        }
                    });
                },
                "columns": [
                    { data: "Teacher" },
                    { data: "Major" },
                    { data: "Start" },
                    { data: "Last" },
                    {
                        data: "Filepath", "render": function (data, type, row) {
                            if (data)
                                return "<a download='file' href=" + data + " target='_blank'>" + data + "</a>";
                            else
                                return "无";
                        }
                    },
                    {
                        data: "ID",
                        "render": function (data, type, row) {;
                            var html;

                            html = "<a class='btn btn-xs btn-primary' onclick='DownloadModel(" + data + ")'>打包下载学生提交</a>";
                            html += "&nbsp;<a class='btn btn-xs btn-danger'onclick='ClearModel(" + data + ")' >清除考试</a>";

                            return html;
                        }
                    }
                ],
                "language": {
                    "sProcessing": "处理中...",
                    "sLengthMenu": "每页显示 _MENU_ 项结果",
                    "sZeroRecords": "没有匹配结果",
                    "sInfo": "当前显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
                    "sInfoEmpty": "当前显示第 0 至 0 项结果，共 0 项",
                    "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                    "sInfoPostFix": "",
                    "sSearch": "关键字搜索:",
                    "sUrl": "",
                    "sEmptyTable": "表中数据为空",
                    "sLoadingRecords": "载入中...",
                    "sInfoThousands": ",",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "上页",
                        "sNext": "下页",
                        "sLast": "末页"
                    },
                    "oAria": {
                        "sSortAscending": ": 以升序排列此列",
                        "sSortDescending": ": 以降序排列此列"
                    }
                },
                "buttons": []
            })
        });
       
        function DownloadModel(id) {            
            $.dynamicSubmit = function (url, datas) {

                var form = $('#dynamicForm');

                if (form.length <= 0) {
                    form = $("<form>");
                    form.attr('id', 'dynamicForm');
                    form.attr('style', 'display:none');
                    form.attr('target', '');
                    form.attr('method', 'post');

                    $('body').append(form);
                }

                form = $('#dynamicForm');
                form.attr('action', url);
                form.empty();

                if (datas && typeof (datas) == 'object') {
                    for (var item in datas) {
                        var $_input = $('<input>');
                        $_input.attr('type', 'hidden');
                        $_input.attr('name', item);
                        $_input.val(datas[item]);

                        $_input.appendTo(form);
                    }
                }

                form.submit();
            };
            $.dynamicSubmit("/ExamEnd/DownloadFile/", {
                "id": id
            });
        }

        function ClearModel(model) {
            swal({
                title: "确定清除此考试?",
                type: "warning",
                showCancelButton: true,
                cancelButtonText: "取消",
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "确认",
                closeOnConfirm: false
            }, function () {
                $.post("/ExamEnd/Clear/" + model, null, function (res) {
                    if (res.result == 0) {
                        swal("清除失败!", "没用可供清除的数据", "error");
                    } else if (res.result == 100) {
                        location.href = "/Login/Index";
                    } else {
                        table.ajax.reload();
                        swal("考试已清除!", "", "success");
                    }
                });
            });
        }
    </script>
}

